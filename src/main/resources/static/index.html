<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>å•†è¶…åº“å­˜ç®¡ç†ç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* å®šä¹‰CSSå˜é‡ç”¨äºç»Ÿä¸€é¢œè‰²ä¸»é¢˜ */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --primary-gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color), var(--accent-color));
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa, #e4edf5);
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 250px;
            background: var(--primary-gradient);
            background-size: 400% 400%;
            animation: gradientShift 10s ease infinite;
            color: white;
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 18px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 14px 18px;
            cursor: pointer;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar li:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .sidebar li.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            padding: 30px;
            background: linear-gradient(to bottom, #ffffff, #f8fafc);
            overflow-y: auto;
        }

        .page-title {
            font-size: 26px;
            color: var(--primary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--accent-color);
            position: relative;
        }

        .page-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--primary-gradient);
            border-radius: 3px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: var(--transition);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            text-decoration: none;
            min-width: 120px;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(90deg, #ff5f6d, #ffc371);
            box-shadow: 0 4px 15px rgba(255, 95, 109, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 95, 109, 0.6);
        }

        .btn-sm {
            padding: 8px 16px;
            min-width: auto;
            font-size: 13px;
        }

        .page {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #eef2f7;
        }

        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: var(--card-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid #eef2f7;
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        th {
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }

        tr {
            transition: var(--transition);
        }

        tr:hover {
            background-color: #f0f8ff !important; /* æ‚¬åœé«˜äº®æ•ˆæœ */
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        tr.low-stock {
            background-color: #ffebee !important; /* ä½åº“å­˜å•†å“èƒŒæ™¯è‰² */
            border-left: 4px solid #e74c3c !important; /* ä½åº“å­˜å•†å“å·¦ä¾§è¾¹æ¡† */
            color: #c62828;
        }

        tr.low-stock:hover {
            background-color: #ffcdd2 !important; /* ä½åº“å­˜å•†å“æ‚¬åœæ•ˆæœ */
        }

        .sort-arrow {
            font-size: 0.8em;
            margin-left: 5px;
            opacity: 0.5;
        }

        .sort-arrow.active {
            opacity: 1;
            color: var(--primary-color);
        }

        .sort-arrow.asc::after {
            content: 'â–²';
        }

        .sort-arrow.desc::after {
            content: 'â–¼';
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 600;
            font-size: 14px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: end;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .status-bar {
            margin-top: 25px;
            padding: 15px;
            background: linear-gradient(90deg, #e8f4fd, #f0f9ff);
            border-left: 5px solid var(--primary-color);
            color: var(--primary-color);
            font-size: 14px;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .error {
            background: linear-gradient(90deg, #fadbd8, #fad0c4);
            color: #c0392b;
            border-left-color: #e74c3c;
        }

        /* åˆ†é¡µæ§ä»¶æ ·å¼ */
        #paginationControls {
            text-align: center;
            margin: 25px 0;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }

        #paginationControls button {
            padding: 10px 20px;
            margin: 0 8px;
            font-size: 15px;
            border: none;
            border-radius: 8px;
            background: #f1f5f9;
            color: #4a5568;
            cursor: pointer;
            transition: var(--transition);
        }

        #paginationControls button:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        #paginationControls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* å¡ç‰‡å¼å¸ƒå±€ */
        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid #eef2f7;
        }

        .card-header {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f5f9;
        }

        .card-content {
            padding: 15px 0;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .animate-on-hover {
            transition: var(--transition);
        }

        .animate-on-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ“ä½œåé¦ˆæç¤º */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(90deg, #56ab2f, #a8e063);
        }

        .notification.error {
            background: linear-gradient(90deg, #ff5f6d, #ffc371);
        }

        .notification.info {
            background: linear-gradient(90deg, #6a11cb, #2575fc);
        }
    </style>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- å·¦ä¾§ï¼šä¾§è¾¹æ  -->
    <div class="sidebar">
        <h2>ğŸ›’ åº“å­˜ç³»ç»Ÿ</h2>
        <ul id="menu">
            <li data-page="add-product"><span>â•</span> æ·»åŠ å•†å“</li>
            <li data-page="product-list"><span>ğŸ“‹</span> å•†å“åˆ—è¡¨</li>
            <li data-page="stock-control"><span>ğŸ“¦</span> å…¥åº“å‡ºåº“</li>
            <li data-page="charts"><span>ğŸ“Š</span> å›¾è¡¨åˆ†æ</li>
            <li data-page="logs"><span>ğŸ“</span> æ“ä½œæ—¥å¿—</li>
            <li data-page="excel"><span>ğŸ“¤</span> Excelå¯¼å…¥å¯¼å‡º</li>
            <li data-page="recommend"><span>ğŸ¤–</span> æ™ºèƒ½è¡¥è´§å»ºè®®</li>
        </ul>
    </div>

    <!-- å³ä¾§ï¼šä¸»å†…å®¹åŒº -->
    <div class="main-content" id="mainContent"></div>
</div>

<!-- çŠ¶æ€æç¤ºæ  -->
<div id="statusBar" class="status-bar">å‡†å¤‡å°±ç»ª</div>

<script>
    const API_URL = 'http://localhost:8080/api/products';
    let allProducts = [];

    // ================= [é¡µé¢è·¯ç”±ç®¡ç†å™¨] ==================
    const pages = {
        'add-product': () => `
      <div class="page">
        <h2 class="page-title">â• æ·»åŠ æ–°å•†å“</h2>
        
        <div class="card animate-on-hover">
          <div class="card-header">å•†å“ä¿¡æ¯</div>
          <div class="card-content">
            <form id="addForm" style="max-width: 600px;">
              <div class="form-row">
                <div class="form-group">
                  <label for="id">å•†å“ç¼–å·</label>
                  <input type="text" id="id" placeholder="å¦‚ SP0001" required>
                </div>
                <div class="form-group">
                  <label for="name">åç§°</label>
                  <input type="text" id="name" placeholder="å¦‚ çŸ¿æ³‰æ°´" required>
                </div>
                <div class="form-group">
                  <label for="category">åˆ†ç±»</label>
                  <select id="category" required>
                    <option value="">é€‰æ‹©åˆ†ç±»</option>
                    <option value="é¥®æ–™">é¥®æ–™</option>
                    <option value="é›¶é£Ÿ">é›¶é£Ÿ</option>
                    <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="buyPrice">è¿›ä»·ï¼ˆå…ƒï¼‰</label>
                  <input type="number" step="0.01" min="0" id="buyPrice" required>
                </div>
                <div class="form-group">
                  <label for="sellPrice">å”®ä»·ï¼ˆå…ƒï¼‰</label>
                  <input type="number" step="0.01" min="0" id="sellPrice" required>
                </div>
                <div class="form-group">
                  <label for="stock">åº“å­˜æ•°é‡</label>
                  <input type="number" min="0" id="stock" required>
                </div>
              </div>
              <button type="submit" class="btn" style="background: linear-gradient(90deg, #00b09b, #96c93d);">âœ… æ·»åŠ å•†å“</button>
            </form>
          </div>
        </div>
      </div>
    `,

        'product-list': () => `
      <div class="page">
        <h2 class="page-title">ğŸ“‹ å•†å“åˆ—è¡¨</h2>
        
        <!-- æœç´¢å’Œæ“ä½œåŒºåŸŸ -->
        <div class="card animate-on-hover" style="margin-bottom: 20px; padding: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div>
              <button onclick="renderPage('add-product')" class="btn" style="background: linear-gradient(90deg, #56ab2f, #a8e063);">
                â• æ·»åŠ æ–°å•†å“
              </button>
            </div>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <input type="text" id="searchInput" placeholder="æœç´¢å•†å“..." style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: var(--border-radius); width: 200px;" onkeyup="handleSearchKey(event)"/>
              <select id="searchCategory" onchange="searchProducts()" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: var(--border-radius); min-width: 120px;">
                <option value="">å…¨éƒ¨åˆ†ç±»</option>
                <option value="é¥®æ–™">é¥®æ–™</option>
                <option value="é›¶é£Ÿ">é›¶é£Ÿ</option>
                <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
              <button class="btn btn-sm" onclick="searchProducts()" style="min-width: auto; background: linear-gradient(90deg, #6a11cb, #2575fc);">
                ğŸ” æœç´¢
              </button>
              <button class="btn btn-sm" onclick="clearSearch()" style="min-width: auto; background: linear-gradient(90deg, #ff9a9e, #fecfef);">
                ğŸ—‘ï¸ æ¸…ç©º
              </button>
            </div>
          </div>
        </div>

        <!-- å•†å“è¡¨æ ¼ -->
        <div class="card animate-on-hover">
          <div class="card-header">å•†å“ä¿¡æ¯</div>
          <div class="card-content">
            <table id="productTable">
              <thead><tr>
                <th onclick="sortTable('id')">ç¼–å· <span class="sort-arrow" id="sort-id"></span></th>
                <th onclick="sortTable('name')">åç§° <span class="sort-arrow" id="sort-name"></span></th>
                <th onclick="sortTable('category')">åˆ†ç±» <span class="sort-arrow" id="sort-category"></span></th>
                <th onclick="sortTable('buyPrice')">è¿›ä»· <span class="sort-arrow" id="sort-buyPrice"></span></th>
                <th onclick="sortTable('sellPrice')">å”®ä»· <span class="sort-arrow" id="sort-sellPrice"></span></th>
                <th onclick="sortTable('stock')">åº“å­˜ <span class="sort-arrow" id="sort-stock"></span></th>
                <th>æ“ä½œ</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- åˆ†é¡µæ§ä»¶ -->
        <div id="paginationControls" style="text-align:center; margin:25px 0; padding: 20px; background: white; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
          <button id="prevBtn" class="btn btn-sm" disabled>â—€ ä¸Šä¸€é¡µ</button>
          <span id="pageInfo" style="margin: 0 15px; color: #4a5568;">æ­£åœ¨åŠ è½½...</span>
          <button id="nextBtn" class="btn btn-sm">ä¸‹ä¸€é¡µ â–¶</button>
        </div>
      </div>
    `,

        'stock-control': () => `
      <div class="page">
        <h2 class="page-title">ğŸ“¦ å…¥åº“ / å‡ºåº“</h2>
        <form id="stockForm">
          <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap">
            <div style="flex:1;min-width:200px;">
              <label>é€‰æ‹©å•†å“ï¼š</label>
              <select id="productId" style="width:100%;padding:8px;" required>
                <option value="">-- è¯·é€‰æ‹© --</option>
              </select>
            </div>
            <div>
              <label><input type="radio" name="action" value="restock" checked> å…¥åº“</label>
              <label><input type="radio" name="action" value="sell"> å‡ºåº“</label>
            </div>
            <div style="flex:1;min-width:150px;">
              <label>æ•°é‡ï¼š</label>
              <input type="number" id="quantity" min="1" value="1" style="width:100%" required>
            </div>
            <button type="submit" class="btn" style="background: linear-gradient(90deg, #ff9a9e, #fecfef);">æ‰§è¡Œ</button>
          </div>
        </form>
        
        <!-- æœç´¢å•†å“åŠŸèƒ½ -->
        <div class="card animate-on-hover" style="margin-top: 20px;">
          <div class="card-header">ğŸ” æœç´¢å•†å“å¿«é€Ÿå®šä½</div>
          <div class="card-content">
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <input type="text" id="stockSearchInput" placeholder="æœç´¢å•†å“..." style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: var(--border-radius); width: 200px;" onkeyup="handleStockSearchKey(event)"/>
              <select id="stockSearchCategory" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: var(--border-radius); min-width: 120px;">
                <option value="">å…¨éƒ¨åˆ†ç±»</option>
                <option value="é¥®æ–™">é¥®æ–™</option>
                <option value="é›¶é£Ÿ">é›¶é£Ÿ</option>
                <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
              <button class="btn btn-sm" onclick="searchProductsForStock()" style="min-width: auto; background: linear-gradient(90deg, #6a11cb, #2575fc);">
                ğŸ” æœç´¢
              </button>
              <button class="btn btn-sm" onclick="loadAllProductsForStock()" style="min-width: auto; background: linear-gradient(90deg, #ff9a9e, #fecfef);">
                ğŸ”„ å…¨éƒ¨
              </button>
            </div>
          </div>
        </div>
      </div>
    `,

        'charts': () => `
      <div class="page">
        <h2 class="page-title">ğŸ“Š æ•°æ®å¯è§†åŒ–</h2>
        
        <!-- å›¾è¡¨å¡ç‰‡ -->
        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
          <div class="card animate-on-hover" style="flex: 1; min-width: 400px;">
            <div class="card-header">ğŸ“Š åˆ†ç±»ç»Ÿè®¡</div>
            <div class="card-content">
              <canvas id="categoryChart" height="300"></canvas>
            </div>
          </div>
          <div class="card animate-on-hover" style="flex: 1; min-width: 400px;">
            <div class="card-header">âš ï¸ ä½åº“å­˜é¢„è­¦</div>
            <div class="card-content">
              <canvas id="lowStockChart" height="300"></canvas>
            </div>
          </div>
        </div>
        
        <!-- ä½åº“å­˜è¯¦ç»†åˆ—è¡¨ -->
        <div class="card animate-on-hover" style="margin-top: 20px;">
          <div class="card-header">ğŸ“‹ ä½åº“å­˜å•†å“è¯¦æƒ…</div>
          <div class="card-content">
            <div id="lowStockList" style="max-height: 300px; overflow-y: auto;">
              <p style="text-align: center; color: #718096; padding: 20px;">æ­£åœ¨åŠ è½½...</p>
            </div>
          </div>
        </div>
        
        <!-- åˆ·æ–°æŒ‰é’® -->
        <div style="margin-top: 20px; text-align: center;">
          <button onclick="drawCategoryChart(); drawLowStockChart(); loadLowStockList();" class="btn" style="background: linear-gradient(90deg, #6a11cb, #2575fc);">
            ğŸ”„ åˆ·æ–°å›¾è¡¨
          </button>
        </div>
      </div>
    `,

        'logs': () => `
      <div class="page">
        <h2 class="page-title">ğŸ“ æ“ä½œæ—¥å¿—</h2>
        
        <!-- æ•°é‡é€‰æ‹©å’Œæ“ä½œæŒ‰é’® -->
        <div style="margin-bottom: 20px; text-align: center;">
          <div style="display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label for="logLimit" style="font-weight: 600; color: #2d3748;">æ¯é¡µæ˜¾ç¤ºï¼š</label>
              <select id="logLimit" onchange="changeLogLimit()" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: var(--border-radius);">
                <option value="5">5æ¡</option>
                <option value="10" selected>10æ¡</option>
                <option value="20">20æ¡</option>
                <option value="50">50æ¡</option>
              </select>
            </div>
            <button onclick="loadLogs()" class="btn" style="background: linear-gradient(90deg, #6a11cb, #2575fc); min-width: auto;">
              ğŸ”„ åˆ·æ–°æ—¥å¿—
            </button>
          </div>
        </div>
        
        <!-- æ—¥å¿—å¡ç‰‡ -->
        <div class="card animate-on-hover">
          <div class="card-header">ğŸ“‹ æ“ä½œè®°å½•</div>
          <div class="card-content">
            <div id="logTableContainer">
              <table id="logTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: var(--primary-gradient); color: white;">
                    <th style="padding: 12px; text-align: left;">æ“ä½œç±»å‹</th>
                    <th style="padding: 12px; text-align: left;">å•†å“åç§°</th>
                    <th style="padding: 12px; text-align: left;">æ•°é‡</th>
                    <th style="padding: 12px; text-align: left;">æ—¶é—´</th>
                  </tr>
                </thead>
                <tbody id="logTableBody">
                  <tr>
                    <td colspan="4" style="padding: 20px; text-align: center; color: #718096;">æ­£åœ¨åŠ è½½...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- åˆ†é¡µæ§ä»¶ -->
        <div id="logPaginationControls" style="text-align: center; margin: 25px 0; padding: 20px; background: white; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
          <button id="logPrevBtn" class="btn btn-sm" disabled>â—€ ä¸Šä¸€é¡µ</button>
          <span id="logPageInfo" style="margin: 0 15px; color: #4a5568;">æ­£åœ¨åŠ è½½...</span>
          <button id="logNextBtn" class="btn btn-sm">ä¸‹ä¸€é¡µ â–¶</button>
        </div>
      </div>
    `,

        'excel': () => `
      <div class="page">
        <h2 class="page-title">ğŸ“¤ Excel æ‰¹é‡å¤„ç†</h2>
        
        <!-- å¯¼å‡ºå¡ç‰‡ -->
        <div class="card animate-on-hover" style="margin-bottom: 25px;">
          <div class="card-header">ğŸ“¥ æ•°æ®å¯¼å‡º</div>
          <div class="card-content">
            <div style="text-align: center; padding: 20px;">
              <a href="http://localhost:8080/api/excel/export" class="btn" style="background: linear-gradient(90deg, #56ab2f, #a8e063); min-width: 200px;">
                ğŸ“¥ å¯¼å‡ºä¸º Excel
              </a>
            </div>
          </div>
        </div>
        
        <!-- å¯¼å…¥å¡ç‰‡ -->
        <div class="card animate-on-hover">
          <div class="card-header">ğŸ“¥ æ•°æ®å¯¼å…¥</div>
          <div class="card-content">
            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
              <div style="width: 100%; max-width: 400px;">
                <label style="display: block; margin-bottom: 8px; color: #2d3748; font-weight: 600;">é€‰æ‹© Excel æ–‡ä»¶</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: var(--border-radius);"/>
              </div>
              <button onclick="importExcel()" class="btn" style="background: linear-gradient(90deg, #ff9a9e, #fecfef); min-width: 150px;">
                ğŸ“¤ å¼€å§‹å¯¼å…¥
              </button>
              <div id="importResult" style="margin-top: 15px; padding: 12px; border-radius: var(--border-radius); background: #f7fafc; width: 100%; text-align: center; display: none;"></div>
            </div>
          </div>
        </div>
      </div>
    `,

        'recommend': () => `
      <div class="page">
        <h2 class="page-title">ğŸ¤– æ™ºèƒ½è¡¥è´§å»ºè®®</h2>

        <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
        <div style="margin-bottom: 20px;">
          <button onclick="refreshRecommendCache()" class="btn btn-sm" style="background: linear-gradient(90deg, #ff9a9e, #fecfef);">
            ğŸ”„ å¼ºåˆ¶åˆ·æ–°ç¼“å­˜
          </button>
        </div>

        <!-- ç­›é€‰æ¡ä»¶å¡ç‰‡ -->
        <div class="card animate-on-hover">
          <div class="card-header">ğŸ” ç­›é€‰æ¡ä»¶</div>
          <div class="card-content">
            <div style="display:flex;gap:20px;flex-wrap:wrap;align-items:end;">
              <div class="form-group">
                <label>æ˜¾ç¤ºæ•°é‡</label>
                <select id="topK" style="width:100%;">
                  <option value="5">Top 5</option>
                  <option value="10" selected>Top 10</option>
                  <option value="20">Top 20</option>
                  <option value="50">Top 50</option>
                </select>
              </div>
              <div class="form-group">
                <label>å•†å“åˆ†ç±»</label>
                <select id="categoryFilter" style="width:100%;">
                  <option value="">å…¨éƒ¨åˆ†ç±»</option>
                  <option value="é¥®æ–™">é¥®æ–™</option>
                  <option value="é›¶é£Ÿ">é›¶é£Ÿ</option>
                  <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
                  <option value="ç”Ÿé²œ">ç”Ÿé²œ</option>
                  <option value="é€Ÿé£Ÿ">é€Ÿé£Ÿ</option>
                </select>
              </div>
              <div class="form-group">
                <label>æœ€ä½å¾—åˆ†</label>
                <input type="number" id="minScore" value="0" step="0.1" min="0" max="3" style="width:100%;">
              </div>
              <button onclick="refreshRecommendList()" class="btn" style="min-width: 100px;">
                ğŸ”„ åˆ·æ–°æ¨è
              </button>
            </div>
          </div>
        </div>

        <!-- æ¨èè¡¨æ ¼ -->
        <div class="card animate-on-hover">
          <div class="card-header">ğŸ“‹ æ¨èåˆ—è¡¨</div>
          <div class="card-content">
            <table id="recommendTable" style="width:100%; margin-top:10px;">
              <thead><tr>
                <th>å•†å“</th>
                <th>åˆ†ç±»</th>
                <th>å½“å‰åº“å­˜</th>
                <th>å‘¨é”€é‡</th>
                <th>å»ºè®®è¿›è´§</th>
                <th>ç»¼åˆå¾—åˆ†</th>
                <th>AIè§£é‡Š</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- AIè§£é‡Šæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="ai-explanation-section" class="card" style="display: none;">
          <div class="card-header">ğŸ¤– AI å†³ç­–è¯´æ˜</div>
          <div class="card-content">
            <p id="ai-explanation-content" style="color: #555; font-style: italic; margin: 0;">ç‚¹å‡»"AIè§£é‡Š"æŒ‰é’®æŸ¥çœ‹è¡¥è´§å»ºè®®çš„è¯¦ç»†åŸå› </p>
          </div>
        </div>

        <!-- åˆ†é¡µæ§ä»¶ -->
        <div id="paginationControls" style="text-align:center; margin:25px 0; padding: 20px; background: white; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
          <button id="prevBtn" class="btn btn-sm" disabled>â—€ ä¸Šä¸€é¡µ</button>
          <span id="pageInfo" style="margin: 0 15px; color: #4a5568;">ç‚¹å‡»ã€åˆ·æ–°ã€‘å¼€å§‹åˆ†æ</span>
          <button id="nextBtn" class="btn btn-sm">ä¸‹ä¸€é¡µ â–¶</button>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="recommendStatus" style="text-align:center; padding:15px;"></div>
      </div>
    `
    };

    function renderPage(pageName) {
        document.getElementById('mainContent').innerHTML = pages[pageName]();

        switch (pageName) {
            case 'product-list':
                isProductInitialLoad = true; // é‡ç½®ä¸ºé¦–æ¬¡åŠ è½½çŠ¶æ€
                loadProducts(0); // é»˜è®¤åŠ è½½ç¬¬ä¸€é¡µ
                break;
            case 'stock-control':
                refreshProductSelect();
                break;
            case 'charts':
                drawCategoryChart();
                drawLowStockChart();
                loadLowStockList();
                break;
            case 'logs':
                resetLogInitialLoad(); // é‡ç½®ä¸ºé¦–æ¬¡åŠ è½½çŠ¶æ€
                loadLogs(0); // é»˜è®¤åŠ è½½ç¬¬ä¸€é¡µ
                break;
            case 'recommend':
                initRecommendPage(); // åˆå§‹åŒ–æ¨èé¡µé€»è¾‘
                break;
        }

        afterRenderActions(pageName);
    }

    // èœå•ç‚¹å‡»åˆ‡æ¢
    document.querySelectorAll('#menu li').forEach(item => {
        item.addEventListener('click', function () {
            document.querySelectorAll('#menu li').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            const page = this.getAttribute('data-page');
            renderPage(page);
        });
    });

    // ============ é¡µé¢åŠŸèƒ½å‡½æ•° ============
    function showStatus(msg, isError = false) {
        const statusBar = document.getElementById('statusBar');
        statusBar.textContent = msg;
        statusBar.className = 'status-bar ' + (isError ? 'error' : '');
    }

    // æ˜¾ç¤ºæ“ä½œé€šçŸ¥
    function showNotification(message, type = 'info') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(notification);
        
        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading(elementId, show = true) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        if (show) {
            element.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading" style="display: inline-block; margin: 0 auto;"></div> <span style="margin-left: 10px;">åŠ è½½ä¸­...</span></div>';
        }
    }

    // è¡¨æ ¼æ’åºåŠŸèƒ½
    let currentSort = { column: null, direction: 'asc' };
    
    function sortTable(column) {
        // åˆ‡æ¢æ’åºæ–¹å‘
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }
        
        // æ›´æ–°æ’åºç®­å¤´
        updateSortArrows(column);
        
        // å¯¹å½“å‰æ˜¾ç¤ºçš„è¡¨æ ¼è¡Œè¿›è¡Œæ’åº
        const tbody = document.querySelector('#productTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            let aVal = a.children[getColumnIndex(column)].textContent;
            let bVal = b.children[getColumnIndex(column)].textContent;
            
            // ç‰¹æ®Šå¤„ç†æ•°å€¼ç±»å‹
            if (column === 'buyPrice' || column === 'sellPrice' || column === 'stock') {
                aVal = parseFloat(aVal);
                bVal = parseFloat(bVal);
            }
            
            if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });
        
        // é‡æ–°æ·»åŠ æ’åºåçš„è¡Œ
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function getColumnIndex(column) {
        const headers = ['id', 'name', 'category', 'buyPrice', 'sellPrice', 'stock', 'æ“ä½œ'];
        return headers.indexOf(column);
    }
    
    function updateSortArrows(activeColumn) {
        // æ¸…é™¤æ‰€æœ‰ç®­å¤´çš„æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.sort-arrow').forEach(arrow => {
            arrow.className = 'sort-arrow';
        });
        
        // ä¸ºå½“å‰æ’åºåˆ—è®¾ç½®ç®­å¤´
        const activeArrow = document.getElementById(`sort-${activeColumn}`);
        if (activeArrow) {
            activeArrow.classList.add('active', currentSort.direction);
        }
    }

    let isProductInitialLoad = true; // æ ‡è®°å•†å“åˆ—è¡¨æ˜¯å¦ä¸ºé¦–æ¬¡åŠ è½½
    
    /**
     * åŠ è½½å•†å“åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
     */
    async function loadProducts(page = 0) {
        try {
            const res = await fetch(`http://localhost:8080/api/products?page=${page}&size=10`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            // âœ… å…³é”®ä¿®å¤ï¼šä¿å­˜åˆ°å…¨å±€å˜é‡
            allProducts = data.content;

            // æ¸²æŸ“è¡¨æ ¼
            const tbody = document.querySelector('#productTable tbody');
            tbody.innerHTML = '';
            data.content.forEach(p => {
                const tr = document.createElement('tr');
                // ä¸ºä½åº“å­˜å•†å“æ·»åŠ ç‰¹æ®Šç±»
                if (p.stock < 10) {
                    tr.classList.add('low-stock');
                    tr.title = 'âš ï¸ åº“å­˜ç´§å¼ ï¼Œè¯·åŠæ—¶è¡¥è´§ï¼';
                }
                tr.innerHTML = `
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${p.category}</td>
        <td>${p.buyPrice.toFixed(2)}</td>
        <td>${p.sellPrice.toFixed(2)}</td>
        <td>${p.stock}</td>
        <td><button class="btn btn-danger" onclick="deleteProduct('${p.id}')">ğŸ—‘ï¸ åˆ é™¤</button></td>
      `;
                tbody.appendChild(tr);
            });

            // æ›´æ–°åˆ†é¡µæ§ä»¶
            updateProductPaginationControls(data, page);

            // åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ˜¾ç¤ºé€šçŸ¥
            if (isProductInitialLoad) {
                showNotification(`å…±åŠ è½½ ${data.totalElements} æ¡å•†å“è®°å½•`, 'info');
                isProductInitialLoad = false;
            }
        } catch (err) {
            console.error("åŠ è½½å•†å“å¤±è´¥", err);
            showNotification("âŒ è¿æ¥å¤±è´¥ï¼šè¯·ç¡®è®¤ Java åç«¯å·²å¯åŠ¨ï¼", 'error');
        }
    }

    function updateProductPaginationControls(data, page) {
        const pageInfo = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        if (!pageInfo || !prevBtn || !nextBtn) return;

        pageInfo.textContent = `ç¬¬ ${page + 1} é¡µ / å…± ${data.totalPages} é¡µ`;
        prevBtn.disabled = data.first;
        nextBtn.disabled = data.last;

        prevBtn.onclick = () => !data.first && loadProducts(page - 1);
        nextBtn.onclick = () => !data.last && loadProducts(page + 1);
    }

    async function refreshProductSelect() {
        const select = document.getElementById('productId');
        if (!select) return;
        
        select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
        
        try {
            // ä»åç«¯è·å–æœ€æ–°çš„å•†å“åˆ—è¡¨
            const res = await fetch('http://localhost:8080/api/products');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();
            allProducts = data.content; // æ›´æ–°å…¨å±€å˜é‡
            
            allProducts.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.name} (${p.stock} ä»¶)`;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error("åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥", err);
            // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å…¨å±€å˜é‡ä¸­çš„æ•°æ®
            if (allProducts && allProducts.length > 0) {
                allProducts.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = `${p.name} (${p.stock} ä»¶)`;
                    select.appendChild(opt);
                });
            }
        }
    }

    async function deleteProduct(id) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¼–å·ä¸º ${id} çš„å•†å“å—ï¼Ÿ`)) return;
        try {
            const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            if (res.ok) {
                showNotification(`âœ… æˆåŠŸåˆ é™¤å•†å“ ${id}`, 'success');
                renderPage('product-list');
            } else {
                showNotification('âŒ åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (err) {
            showNotification('âŒ ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åˆ é™¤', 'error');
        }
    }

    // ============ è¡¨å•æäº¤äº‹ä»¶ç»‘å®š ============
    function afterRenderActions(pageName) {
        if (pageName === 'add-product') {
            const form = document.getElementById('addForm');
            if (form) {
                form.onsubmit = async function(e) {
                    e.preventDefault();
                    const newProduct = {
                        id: document.getElementById('id').value,
                        name: document.getElementById('name').value,
                        category: document.getElementById('category').value,
                        buyPrice: parseFloat(document.getElementById('buyPrice').value),
                        sellPrice: parseFloat(document.getElementById('sellPrice').value),
                        stock: parseInt(document.getElementById('stock').value)
                    };
                    try {
                        const res = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newProduct)
                        });
                        if (res.ok) {
                            document.getElementById('addForm').reset()
                            autoFillProductId();
                            showNotification('âœ… æ·»åŠ æˆåŠŸ', 'success');
                            renderPage('product-list');
                        } else {
                            showNotification('âŒ æ·»åŠ å¤±è´¥ï¼šå¯èƒ½ç¼–å·é‡å¤', 'error');
                        }
                    } catch (err) {
                        showNotification('âŒ æäº¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯', 'error');
                    }
                };
            }
        }

        if (pageName === 'stock-control') {
            const form = document.getElementById('stockForm');
            if (form) {
                form.onsubmit = async function(e) {
                    e.preventDefault();
                    const id = document.getElementById('productId').value;
                    const quantity = parseInt(document.getElementById('quantity').value);
                    const action = document.querySelector('input[name="action"]:checked').value;
                    const product = allProducts.find(p => p.id === id);
                    if (!product) return alert("è¯·é€‰æ‹©æœ‰æ•ˆå•†å“");
                    let newStock = action === 'restock' ? product.stock + quantity : product.stock - quantity;
                    if (newStock < 0) return alert("å‡ºåº“æ•°é‡ä¸èƒ½è¶…è¿‡å½“å‰åº“å­˜ï¼");
                    const updated = { ...product, stock: newStock };
                    try {
                        const res = await fetch(`${API_URL}/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updated)
                        });
                        if (res.ok) {
                            showNotification(`âœ… æˆåŠŸ${action === 'restock' ? 'å…¥åº“' : 'å‡ºåº“'} ${quantity} ä»¶`, 'success');
                            renderPage('product-list');
                        } else {
                            showNotification('âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                        }
                    } catch (err) {
                        showNotification('âŒ ç½‘ç»œé”™è¯¯', 'error');
                    }
                };
            }
        }
    }

    // ============ å›¾è¡¨å‡½æ•° ============
    let categoryChart = null, lowStockChart = null;

    async function drawCategoryChart() {
        try {
            const res = await fetch('http://localhost:8080/api/stats/category');
            const data = await res.json();
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{ data: Object.values(data), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        } catch (err) { console.error('å›¾è¡¨åŠ è½½å¤±è´¥:', err); }
    }

    async function drawLowStockChart() {
        try {
            const res = await fetch('http://localhost:8080/api/alerts/low-stock');
            const products = await res.json();
            const ctx = document.getElementById('lowStockChart').getContext('2d');
            if (lowStockChart) lowStockChart.destroy();
            if (products.length === 0) {
                document.getElementById('lowStockChart').parentElement.innerHTML += '<p style="color:#7f8c8d;text-align:center;">ğŸ‰ æ‰€æœ‰å•†å“åº“å­˜å……è¶³</p>';
                return;
            }
            const labels = products.map(p => p.name), data = products.map(p => p.stock);
            lowStockChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'åº“å­˜æ•°é‡', data, backgroundColor: '#e74c3c' }] },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        } catch (err) { console.error('ä½åº“å­˜å›¾åŠ è½½å¤±è´¥:', err); }
    }

    // åŠ è½½ä½åº“å­˜å•†å“è¯¦ç»†åˆ—è¡¨
    async function loadLowStockList() {
        try {
            const res = await fetch('http://localhost:8080/api/alerts/low-stock');
            const products = await res.json();
            const container = document.getElementById('lowStockList');
            
            if (products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #28a745; font-size: 16px; padding: 20px;">âœ… æ­å–œï¼æ‰€æœ‰å•†å“åº“å­˜å……è¶³</p>';
                return;
            }
            
            // æŒ‰åº“å­˜æ•°é‡æ’åºï¼ˆä»ä½åˆ°é«˜ï¼‰
            products.sort((a, b) => a.stock - b.stock);
            
            let html = '<table style="width: 100%; border-collapse: collapse; border: 1px solid #eef2f7; border-radius: var(--border-radius); overflow: hidden;">' +
                '<thead>' +
                    '<tr style="background: var(--primary-gradient); color: white;">' +
                        '<th style="padding: 12px; text-align: left;">å•†å“åç§°</th>' +
                        '<th style="padding: 12px; text-align: left;">åˆ†ç±»</th>' +
                        '<th style="padding: 12px; text-align: left;">å½“å‰åº“å­˜</th>' +
                        '<th style="padding: 12px; text-align: left;">å®‰å…¨åº“å­˜</th>' +
                        '<th style="padding: 12px; text-align: left;">çŠ¶æ€</th>' +
                    '</tr>' +
                '</thead>' +
                '<tbody>';
            
            products.forEach(p => {
                const stockLevel = p.stock < 5 ? 'å±æ€¥' : p.stock < 10 ? 'è­¦å‘Š' : 'æ³¨æ„';
                const stockColor = p.stock < 5 ? '#dc3545' : p.stock < 10 ? '#ffc107' : '#fd7e14';
                
                html += `<tr style="border-bottom: 1px solid #eef2f7; transition: var(--transition);" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor=''">
                    <td style="padding: 12px; font-weight: 500;">${p.name}</td>
                    <td style="padding: 12px;">${p.category}</td>
                    <td style="padding: 12px; font-weight: bold; color: ${stockColor};">${p.stock}</td>
                    <td style="padding: 12px;">30</td>
                    <td style="padding: 12px;">
                        <span style="padding: 4px 8px; border-radius: 12px; background: ${stockColor}; color: white; font-size: 12px;">
                            ${stockLevel}
                        </span>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (err) {
            console.error('åŠ è½½ä½åº“å­˜åˆ—è¡¨å¤±è´¥:', err);
            const container = document.getElementById('lowStockList');
            container.innerHTML = '<p style="text-align: center; color: #e53e3e; padding: 20px;">âŒ åŠ è½½ä½åº“å­˜åˆ—è¡¨å¤±è´¥</p>';
        }
    }

    // è‡ªåŠ¨å¡«å……ç¼–å·
    async function autoFillProductId() {
        try {
            const res = await fetch('http://localhost:8080/api/products/generate-id');
            const id = await res.text();
            const input = document.getElementById('id');
            if (input && !input.value) input.value = id;
        } catch (err) { console.log('è‡ªåŠ¨ç”Ÿæˆç¼–å·å¤±è´¥'); }
    }

    // æœç´¢å•†å“åŠŸèƒ½
    async function searchProducts() {
        const searchTerm = document.getElementById('searchInput').value;
        const selectedCategory = document.getElementById('searchCategory').value;

        // å¦‚æœæœç´¢è¯å’Œåˆ†ç±»éƒ½ä¸ºç©ºï¼ŒåŠ è½½æ‰€æœ‰å•†å“
        if (!searchTerm && !selectedCategory) {
            isProductInitialLoad = true; // é‡ç½®ä¸ºé¦–æ¬¡åŠ è½½çŠ¶æ€
            loadProducts(0);
            return;
        }

        try {
            let url = 'http://localhost:8080/api/products';
            if (searchTerm) {
                // ä½¿ç”¨æ–°çš„æœç´¢API
                url = `http://localhost:8080/api/products/search?keyword=${encodeURIComponent(searchTerm)}`;
            }

            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            let data;
            if (searchTerm) {
                // æœç´¢APIè¿”å›çš„æ˜¯åˆ—è¡¨ï¼Œä¸æ˜¯åˆ†é¡µæ•°æ®
                data = { content: await res.json() };
            } else {
                data = await res.json();
            }

            // å¦‚æœè¿˜é€‰æ‹©äº†åˆ†ç±»ï¼Œåˆ™è¿›ä¸€æ­¥è¿‡æ»¤
            let filteredProducts = data.content;
            if (selectedCategory) {
                filteredProducts = data.content.filter(p => p.category === selectedCategory);
            }

            // æ¸²æŸ“è¿‡æ»¤åçš„å•†å“
            const tbody = document.querySelector('#productTable tbody');
            tbody.innerHTML = '';
            filteredProducts.forEach(p => {
                const tr = document.createElement('tr');
                // ä¸ºä½åº“å­˜å•†å“æ·»åŠ ç‰¹æ®Šç±»
                if (p.stock < 10) {
                    tr.classList.add('low-stock');
                    tr.title = 'âš ï¸ åº“å­˜ç´§å¼ ï¼Œè¯·åŠæ—¶è¡¥è´§ï¼';
                }
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>${p.category}</td>
                    <td>${p.buyPrice.toFixed(2)}</td>
                    <td>${p.sellPrice.toFixed(2)}</td>
                    <td>${p.stock}</td>
                    <td><button class="btn btn-danger" onclick="deleteProduct('${p.id}')">ğŸ—‘ï¸ åˆ é™¤</button></td>
                `;
                tbody.appendChild(tr);
            });

            // æ›´æ–°åˆ†é¡µæ§ä»¶ä¸ºæœç´¢ç»“æœä¿¡æ¯
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (pageInfo) {
                pageInfo.textContent = `æœç´¢ç»“æœï¼šå…± ${filteredProducts.length} æ¡å•†å“è®°å½•`;
            }
            if (prevBtn) prevBtn.disabled = true;
            if (nextBtn) nextBtn.disabled = true;

            showNotification(`æœç´¢åˆ° ${filteredProducts.length} æ¡å•†å“`, 'info');
        } catch (err) {
            console.error("æœç´¢å•†å“å¤±è´¥", err);
            showNotification("âŒ æœç´¢å¤±è´¥ï¼šè¯·ç¡®è®¤ Java åç«¯å·²å¯åŠ¨ï¼", 'error');
        }
    }

    // å¤„ç†æœç´¢è¾“å…¥æ¡†çš„å›è½¦é”®
    function handleSearchKey(event) {
        if (event.key === 'Enter') {
            searchProducts();
        }
    }

    // æ¸…ç©ºæœç´¢
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchCategory').value = '';
        isProductInitialLoad = true; // é‡ç½®ä¸ºé¦–æ¬¡åŠ è½½çŠ¶æ€
        loadProducts(0); // é‡æ–°åŠ è½½æ‰€æœ‰å•†å“
    }

    // æœç´¢å•†å“ç”¨äºåº“å­˜æ§åˆ¶
    async function searchProductsForStock() {
        const searchTerm = document.getElementById('stockSearchInput').value;
        const selectedCategory = document.getElementById('stockSearchCategory').value;

        try {
            let url = 'http://localhost:8080/api/products';
            if (searchTerm) {
                // ä½¿ç”¨æ–°çš„æœç´¢API
                url = `http://localhost:8080/api/products/search?keyword=${encodeURIComponent(searchTerm)}`;
            }

            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            let allProducts;
            if (searchTerm) {
                // æœç´¢APIè¿”å›çš„æ˜¯åˆ—è¡¨
                allProducts = await res.json();
            } else {
                // è·å–å…¨éƒ¨å•†å“çš„APIè¿”å›åˆ†é¡µæ•°æ®
                const data = await res.json();
                allProducts = data.content;
            }

            // å¦‚æœè¿˜é€‰æ‹©äº†åˆ†ç±»ï¼Œåˆ™è¿›ä¸€æ­¥è¿‡æ»¤
            let filteredProducts = allProducts;
            if (selectedCategory) {
                filteredProducts = allProducts.filter(p => p.category === selectedCategory);
            }

            // æ›´æ–°åº“å­˜æ§åˆ¶é¡µé¢çš„å•†å“é€‰æ‹©ä¸‹æ‹‰æ¡†
            const select = document.getElementById('productId');
            if (select) {
                select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                filteredProducts.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = `${p.name} (${p.stock} ä»¶)`;
                    select.appendChild(opt);
                });
            }

            showNotification(`æœç´¢åˆ° ${filteredProducts.length} ç§å•†å“`, 'info');
        } catch (err) {
            console.error("æœç´¢å•†å“å¤±è´¥", err);
            showNotification("âŒ æœç´¢å¤±è´¥ï¼šè¯·ç¡®è®¤ Java åç«¯å·²å¯åŠ¨ï¼", 'error');
        }
    }

    // å¤„ç†åº“å­˜æœç´¢è¾“å…¥æ¡†çš„å›è½¦é”®
    function handleStockSearchKey(event) {
        if (event.key === 'Enter') {
            searchProductsForStock();
        }
    }

    // åŠ è½½æ‰€æœ‰å•†å“åˆ°åº“å­˜æ§åˆ¶é¡µé¢çš„ä¸‹æ‹‰æ¡†
    async function loadAllProductsForStock() {
        document.getElementById('stockSearchInput').value = '';
        document.getElementById('stockSearchCategory').value = '';
        isProductInitialLoad = true; // é‡ç½®ä¸ºé¦–æ¬¡åŠ è½½çŠ¶æ€
        await refreshProductSelect(); // ä½¿ç”¨æ›´æ–°åçš„å‡½æ•°åˆ·æ–°ä¸‹æ‹‰æ¡†
        showStatus('å·²åŠ è½½å…¨éƒ¨å•†å“');
    }

    // å½“å‰æ—¥å¿—åˆ†é¡µçŠ¶æ€
    let currentLogPage = 0;
    let currentLogSize = 10;
    let totalLogPages = 0;
    let totalLogs = 0;
    let isInitialLoad = true; // æ ‡è®°æ˜¯å¦ä¸ºé¦–æ¬¡åŠ è½½

    // åŠ è½½æ—¥å¿—ï¼ˆåˆ†é¡µï¼‰
    async function loadLogs(page = 0) {
        const logTableBody = document.getElementById('logTableBody');
        const pageInfo = document.getElementById('logPageInfo');
        const prevBtn = document.getElementById('logPrevBtn');
        const nextBtn = document.getElementById('logNextBtn');
        
        if (!logTableBody) return;
        
        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            logTableBody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center;">â³ åŠ è½½ä¸­...</td></tr>';
            
            const res = await fetch(`http://localhost:8080/api/logs/paged?page=${page}&size=${currentLogSize}`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            currentLogPage = data.number;
            totalLogPages = data.totalPages;
            totalLogs = data.totalElements;
            
            // æ¸²æŸ“æ—¥å¿—è¡¨æ ¼
            logTableBody.innerHTML = '';
            if (data.content.length === 0) {
                logTableBody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #718096;">æš‚æ— æ“ä½œè®°å½•</td></tr>';
                pageInfo.textContent = 'æš‚æ— æ—¥å¿—';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            data.content.forEach(log => {
                const tr = document.createElement('tr');
                tr.style.cssText = 'border-bottom: 1px solid #e2e8f0; transition: var(--transition);';
                tr.onmouseover = function() { this.style.backgroundColor = '#f8fafc'; };
                tr.onmouseout = function() { this.style.backgroundColor = ''; };
                
                // æ ¹æ®æ“ä½œç±»å‹è®¾ç½®ä¸åŒé¢œè‰²
                let actionColor = '#48bb78'; // é»˜è®¤ç»¿è‰²
                if (log.action.includes('å…¥åº“')) actionColor = '#48bb78';
                if (log.action.includes('å‡ºåº“')) actionColor = '#e53e3e';
                if (log.action.includes('ä¸Šæ¶')) actionColor = '#3182ce';
                if (log.action.includes('ä¸‹æ¶')) actionColor = '#805ad5';
                
                tr.innerHTML = `
                    <td style="padding: 12px; font-weight: 600; color: ${actionColor};">[${log.action}]</td>
                    <td style="padding: 12px;">${log.productName}</td>
                    <td style="padding: 12px; color: #718096;">Ã— ${log.quantity}</td>
                    <td style="padding: 12px; color: #a0aec0; font-size: 13px;">${formatTime(log.timestamp)}</td>
                `;
                logTableBody.appendChild(tr);
            });
            
            // æ›´æ–°åˆ†é¡µæ§ä»¶
            pageInfo.textContent = `ç¬¬ ${currentLogPage + 1} é¡µ / å…± ${totalLogPages} é¡µ (å…± ${totalLogs} æ¡)`;
            prevBtn.disabled = currentLogPage === 0;
            nextBtn.disabled = currentLogPage === totalLogPages - 1;
            
            // ç»‘å®šåˆ†é¡µæŒ‰é’®äº‹ä»¶
            prevBtn.onclick = () => loadLogs(currentLogPage - 1);
            nextBtn.onclick = () => loadLogs(currentLogPage + 1);
            
            // åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ˜¾ç¤ºé€šçŸ¥
            if (isInitialLoad) {
                showNotification(`âœ… åŠ è½½äº† ${data.content.length} æ¡æ—¥å¿—`, 'info');
                isInitialLoad = false;
            }
            
        } catch (err) {
            console.error("åŠ è½½æ—¥å¿—å¤±è´¥", err);
            logTableBody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #e53e3e;">âŒ æ— æ³•è¿æ¥æ—¥å¿—æœåŠ¡</td></tr>';
            pageInfo.textContent = 'åŠ è½½å¤±è´¥';
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            showNotification('âŒ åŠ è½½æ—¥å¿—å¤±è´¥', 'error');
        }
    }
    
    // æ”¹å˜æ—¥å¿—æ˜¾ç¤ºæ•°é‡
    async function changeLogLimit() {
        const limitSelect = document.getElementById('logLimit');
        if (!limitSelect) return;
        
        currentLogSize = parseInt(limitSelect.value);
        currentLogPage = 0; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        isInitialLoad = true; // é‡ç½®ä¸ºé¦–æ¬¡åŠ è½½çŠ¶æ€
        
        await loadLogs(currentLogPage);
    }
    
    // é‡ç½®æ—¥å¿—é¡µé¢ä¸ºé¦–æ¬¡åŠ è½½çŠ¶æ€
    function resetLogInitialLoad() {
        isInitialLoad = true;
    }

    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN', { hour12: false });
    }

    // Excel å¯¼å…¥
    function importExcel() {
        const fileInput = document.getElementById('excelFile');
        const resultDiv = document.getElementById('importResult');
        if (!fileInput.files.length) {
            resultDiv.innerHTML = 'âŒ è¯·é€‰æ‹©æ–‡ä»¶';
            resultDiv.style.display = 'block';
            resultDiv.style.backgroundColor = '#fed7d7';
            resultDiv.style.color = '#c53030';
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        
        resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨ä¸Šä¼ ...';
        resultDiv.style.display = 'block';
        resultDiv.style.backgroundColor = '#ebf8ff';
        resultDiv.style.color = '#2b6cb0';
        
        fetch('http://localhost:8080/api/excel/import', {
            method: 'POST', 
            body: formData
        })
        .then(res => res.text())
        .then(data => {
            resultDiv.innerHTML = `<span style="color: ${data.includes('æˆåŠŸ') ? '#38a169' : '#e53e3e'}">${data}</span>`;
            resultDiv.style.backgroundColor = data.includes('æˆåŠŸ') ? '#c6f6d5' : '#fed7d7';
            if (data.includes('æˆåŠŸ')) {
                setTimeout(() => {
                    renderPage('product-list');
                }, 1500);
            }
        })
        .catch(() => {
            resultDiv.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯';
            resultDiv.style.backgroundColor = '#fed7d7';
            resultDiv.style.color = '#e53e3e';
        });
    }

    // ============ æ™ºèƒ½æ¨èç›¸å…³å‡½æ•° ============
    let recommendCurrentPage = 0;
    const recommendPageSize = 10;

    /**
     * åˆå§‹åŒ–æ™ºèƒ½æ¨èé¡µé¢
     */
    function initRecommendPage() {
        recommendCurrentPage = 0;
        refreshRecommendList();
    }

    /**
     * ç”¨æˆ·ç‚¹å‡»â€œåˆ·æ–°æ¨èâ€æŒ‰é’® â†’ å›åˆ°ç¬¬ä¸€é¡µ
     */
    function refreshRecommendList() {
        recommendCurrentPage = 0;
        loadRecommendations(recommendCurrentPage);
    }

    /**
     * åŠ è½½æ¨èæ•°æ®
     */
    async function loadRecommendations(page) {
        const tbody = document.querySelector('#recommendTable tbody');
        const statusDiv = document.getElementById('recommendStatus');
        const pageInfo = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        tbody.innerHTML = '';
        statusDiv.textContent = 'ğŸ” æ­£åœ¨åŠ è½½...';
        prevBtn.disabled = true;
        nextBtn.disabled = true;

        try {
            const topKValue = document.getElementById('topK')?.value || '10';
            const category = document.getElementById('categoryFilter')?.value || '';
            const minScore = parseFloat(document.getElementById('minScore')?.value) || 0;

            let url = `http://localhost:8080/api/recommend/top?page=${page}&size=${recommendPageSize}&topK=${topKValue}`;
            if (category) url += `&category=${encodeURIComponent(category)}`;
            if (minScore > 0) url += `&minScore=${minScore}`;

            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();

            // æ¸²æŸ“è¡¨æ ¼
            tbody.innerHTML = '';
            data.content.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td><strong>${item.currentStock}</strong></td>
          <td>${item.weeklySales}</td>
          <td><strong style="color:#d9534f;">${item.suggestedOrder}</strong></td>
          <td>â­ ${item.score.toFixed(2)}</td>
          <td>
              <button class="btn" onclick="showAIDecision('${item.name}', ${item.weeklySales}, ${item.currentStock}, ${item.suggestedOrder})">
                   ğŸ¤– AIè§£é‡Š
              </button>
          </td>
        `;
                tbody.appendChild(tr);
            });

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            recommendCurrentPage = data.number;
            pageInfo.textContent = `ç¬¬ ${data.number + 1} é¡µ / å…± ${data.totalPages} é¡µ`;
            prevBtn.disabled = data.first;
            nextBtn.disabled = data.last;

            prevBtn.onclick = () => !data.first && loadRecommendations(data.number - 1);
            nextBtn.onclick = () => !data.last && loadRecommendations(data.number + 1);

            statusDiv.textContent = `âœ… å·²è¿”å› ${data.content.length} æ¡æ¨èç»“æœ`;

        } catch (err) {
            console.error("åŠ è½½å¤±è´¥", err);
            statusDiv.innerHTML = '<span style="color:red">âŒ è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ</span>';
        }
    }

    /**
     * è°ƒç”¨åç«¯æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜
     */
    async function refreshRecommendCache() {
        if (!confirm("ç¡®å®šè¦å¼ºåˆ¶åˆ·æ–°æ¨èç¼“å­˜å—ï¼Ÿè¿™å°†é‡æ–°åˆ†ææ‰€æœ‰æ—¥å¿—")) return;

        const statusDiv = document.getElementById('recommendStatus');
        statusDiv.textContent = 'ğŸ”„ æ­£åœ¨åˆ·æ–°ç¼“å­˜...';

        try {
            const res = await fetch('http://localhost:8080/api/admin/refresh-recommend-cache', {
                method: 'POST'
            });
            const result = await res.json();

            if (result.status === 'success') {
                alert(result.message);
                refreshRecommendList(); // åˆ·æ–°æ¨èåˆ—è¡¨
            } else {
                alert(result.message);
            }
        } catch (err) {
            console.error("è¯·æ±‚å¤±è´¥", err);
            alert("âŒ è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ");
        }
    }

    /**
     * æ˜¾ç¤ºAIå¯¹è¡¥è´§å»ºè®®çš„è§£é‡Š
     */
    async function showAIDecision(name, weeklySales, currentStock, suggestedOrder) {
        // æ˜¾ç¤ºAIè§£é‡ŠåŒºåŸŸ
        const explanationSection = document.getElementById('ai-explanation-section');
        const explanationContent = document.getElementById('ai-explanation-content');
        
        explanationSection.style.display = 'block';
        explanationContent.innerHTML = `ğŸ¤– <strong>${name}</strong>ï¼šAI æ­£åœ¨åˆ†æä¸­...`;
        
        try {
            // è°ƒç”¨åç«¯AIè§£é‡Šæ¥å£ - ä½¿ç”¨å®Œæ•´URL
            const res = await fetch(
                `http://localhost:8080/api/recommend/explain?product=${encodeURIComponent(name)}&sales=${weeklySales}&stock=${currentStock}&safety=30`
            );
            
            if (res.ok) {
                const text = await res.text();
                explanationContent.innerHTML = `ğŸ’¡ <strong>${name}</strong>ï¼š${text}`;
            } else {
                explanationContent.textContent = 'âŒ AI è§£é‡Šç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
            }
        } catch (err) {
            console.error("AIè§£é‡Šè¯·æ±‚å¤±è´¥", err);
            explanationContent.textContent = 'âŒ ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è·å–AIè§£é‡Š';
        }
    }

    // ============ ä½åº“å­˜æé†’ ============
    async function showLowStockWarning() {
        try {
            const res = await fetch('http://localhost:8080/api/alerts/low-stock');
            const lowStockItems = await res.json();
            if (lowStockItems.length > 0) {
                const message = `âš ï¸ å½“å‰æœ‰ ${lowStockItems.length} ç§å•†å“åº“å­˜ç´§å¼ ï¼š\n\n` +
                    lowStockItems.map(p => `â€¢ ${p.name}ï¼ˆåº“å­˜ï¼š${p.stock}ï¼‰`).join('\n');
                if (confirm(message)) {
                    renderPage('product-list');
                }
            }
        } catch (err) {
            console.warn("æ— æ³•åŠ è½½åº“å­˜è­¦å‘Šä¿¡æ¯", err);
        }
    }

    // ============ åˆå§‹åŒ– ============
    window.onload = async () => {
        renderPage('add-product');
        autoFillProductId();

        setInterval(showLowStockWarning, 1000 * 60 * 30); // æ¯30åˆ†é’Ÿæé†’ä¸€æ¬¡

        try {
            await loadProducts(0);
            await loadLogs();
            showLowStockWarning();
        } catch (err) {
            showNotification("âš ï¸ éƒ¨åˆ†æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ", 'error');
        }
    };
</script>
</body>
</html>
